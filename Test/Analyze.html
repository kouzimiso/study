<!DOCTYPE html>
<html>
<head>
  <title>File Analyzer</title>
  <script src="json2.js"></script>
  <script>
    // 独自定義関数----------------------------------------
    function Analyze(string_data) {
      var dictionary_data = {};
      //if (string_data.includes("WF_EVENT arrive")) {
      if (string_data.indexOf("WF_EVENT arrive") !== -1) {//IE9対策
        dictionary_data["eventName"] = "WF_EVENT arrive";
        dictionary_data["rowData"] = string_data;
      }
      return dictionary_data;
    }
    function StringToAnalyzeData(string_data,browser_IE){
      //List化
      var lines = string_data.split('\r\n');
      var result_list = [];

      for (var i = 0; i < lines.length; i++) {
         //不要なSpaces削除
         var line = lines[i]
         line = browser_IE? line.replace(/^\s+|\s+$/g, ''): line.trim();

         //解析しDictionary Data化
         var result = Analyze(line);
         //解析Dataが有ればListに加える。
         //var data_exist = browser_IE? !IsObjectEmpty(result) :Object.keys(result).length;
         //if (data_exist) {//条件式を変数で受けると動作が遅くなった。
         //if(IsObjectExist(result,browser_IE)){//複数browserを立ち上げると遅い。
         if (browser_IE? !IsObjectEmpty(result) :Object.keys(result).length){//速度はOK。3項演算子使うのは微妙
            result.row = i + 1;
            result_list.push(result);
         }
       }
      return result_list
    }

    // Process管理関数----------------------------------------
    function HandleFileSelect() {
      if (BrowserType() == "Internet Explorer"){
        ProcessIE();
      } else {
        Process();
      }
    }

    function Process() {
      //File読込
      var file_input = document.getElementById('FileInput');
      var file = file_input.files[0];
      var reader = new FileReader();
      //File読込Event登録
      reader.onload = function(e) {
        var file_content = e.target.result;
        //FileData処理
        var analyzed_data = StringToAnalyzeData(file_content,false);
        //JSON Data化
        var json_result = analyzed_data.map(function(data) {
          return JSON.stringify(data);
        }).join('\n');
        //File保存
        SaveToFile(file.name + '.json', json_result);

        // ブラウザに表示
        var json_lines = json_result.split('\n');
        // json_lines = json_lines.slice(0, 3);
        DisplayArray(json_lines,"Display",true);
      };

      reader.readAsText(file);
    }

    // IE用Process管理関数
    //・引数にDefault値使用不能
    //・置換え:FileReader→ActiveXObject("Scripting.FileSystemObject")
    //・置換え:string_data.includes(string)→string_data.indexOf(stirng) !== -1
    //・window.navigator.userAgent.toLowerCase();→agent = window.navigator.userAgent; agent.toLowerCase();
    function ProcessIE() {
      //File読込
      var file_input = document.getElementById('FileInput');
      var file = file_input.value;
      var file_system = new ActiveXObject("Scripting.FileSystemObject");
      var file_stream = file_system.OpenTextFile(file, 1);
      var file_content = file_stream.ReadAll();
      file_stream.Close();
      
      //FileData処理
      var analyzed_data = StringToAnalyzeData(file_content,true);
      //JSON Data化
      var json_result = '';
      for (var j = 0; j < analyzed_data.length; j++) {
        json_result += DictionaryToJSON(analyzed_data[j]) + '\r\n';
      }
      //File保存

      SaveToFileIE(file + '.json', json_result);
      //IEはDownload出来ないので保存場所を表示する。
      DisplayLink(file + '.json', file + '.json', 'body', false);
      // ブラウザに表示
      var json_lines = json_result.split('\n');
      // json_lines = json_lines.slice(0, 3);
      DisplayArray(json_lines, 'Display', true);
    }


    //汎用クラス-----------------------------------
    //(JavaScriptのfunctionは全てクラス。メソッドとクラス変数を持つもの)
    function StringTokenizer(str, delimiter) {
      this.tokens = str.split(delimiter);
      this.index = 0;

      this.hasMoreTokens = function() {
        return this.index < this.tokens.length;
      };

      this.nextToken = function() {
        if (this.hasMoreTokens()) {
          return this.tokens[this.index++];
        }
        return null;
      };
    }
    //汎用関数----------------------------------------
    // オブジェクトが空かどうかをチェックする関数
    function IsObjectEmpty(obj) {
      for (var key in obj) {
         if (obj.hasOwnProperty(key)) {
           return false;
         }
      }
      return true;
    }
    function IsObjectExist(obj,browser_IE) {
      if(browser_IE){
        for (var key in obj) {
           if (obj.hasOwnProperty(key)) {
             return true;
           }
        }
       return false;
     }else{
       return Object.keys(obj).length != 0;
     }
    }
    // 辞書のJSON文字列化関数
    function DictionaryToJSON(obj) {
      var json_string = '{';
      var is_first_property = true;
      for (var key in obj) {
        if (obj.hasOwnProperty(key)) {
          if (!is_first_property) {
            json_string += ',';
          }
          json_string += '"' + key + '":"' + obj[key] + '"';
          is_first_property = false;
        }
      }
      json_string += '}';
      return json_string;
    }
    //文字列表示関数
    function DisplayString(line, element , search_id ) {
      var display_element = search_id ? document.getElementById(element) : document.getElementsByTagName(element)[0];
      display_element.innerHTML = "<p>" + line + "</p>";
    }
    //文字列追記関数
    function DisplayAddString(line, element , search_id ) {
      var display_element = search_id ? document.getElementById(element) : document.getElementsByTagName(element)[0];
      display_element.innerHTML += "<p>" + line + "</p>";
    }
    //文字列表示関数(配列の表示。配列を変更すればいいので追記の関数は用意しない。)
    function DisplayArray(lines, element , search_id ) {
      var display_element = search_id ? document.getElementById(element) : document.getElementsByTagName(element)[0];
      var displayLines = lines.join('<br>');
      display_element.innerHTML = displayLines;
    }

    // リンク追記関数
    function DisplayLink(path, label_text, element, search_id ) {
      var display_element = search_id ? document.getElementById(element) : document.getElementsByTagName(element)[0];
      var link = document.createElement('a');
      link.href = path;
      link.innerText = label_text;
      display_element.appendChild(link);
    }
    //ブラウザ種類判別関数
    function BrowserType(){
      var browser_type ="";
      if (navigator.appName === "Microsoft Internet Explorer" ) {
        return browser_type = "Internet Explorer";
      }
      var agent = window.navigator.userAgent;
      agent = agent.toLowerCase();
      if (agent.indexOf("msie") != -1 || agent.indexOf("trident") != -1) {
        browser_type = "Internet Explorer";
      } else if (agent.indexOf("edg") != -1 || agent.indexOf("edge") != -1) {
        browser_type = "Edge";
      } else if (agent.indexOf("opr") != -1 || agent.indexOf("opera") != -1) {
        browser_type = "Opera";
      } else if (agent.indexOf("chrome") != -1) {
        browser_type = "Chrome";
      } else if (agent.indexOf("safari") != -1) {
        browser_type = "Safari";
      } else if (agent.indexOf("firefox") != -1) {
        browser_type = "FireFox";
      } else if (agent.indexOf("opr") != -1 || agent.indexOf("opera") != -1) {
        browser_type = "Opera";
      }
      return browser_type;
    }
    // ファイル保存関数
    function SaveToFile(fileName, content) {
      var downloadLink = document.createElement('a');
      downloadLink.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
      downloadLink.download = fileName;
      downloadLink.style.display = 'none';
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }
    // ファイル保存関数(IE専用)
    function SaveToFileIE(fileName, content) {
      var file_system = new ActiveXObject("Scripting.FileSystemObject");
      var file_stream = file_system.CreateTextFile(fileName, true);
      file_stream.Write(content);
      file_stream.Close();
    }

  </script>
</head>
<body>
  <h1>File Analyzer</h1>
  <a>InternetExplorerで実行する場合はjson2.jsを同じFolderに置いて実行してください。</a><br>
  <a href="https://cdnjs.cloudflare.com/ajax/libs/json2/20160511/json2.js">https://cdnjs.cloudflare.com/ajax/libs/json2/20160511/json2.js</a>
  <br>
  <input type="File" id="FileInput" />
  <button onclick="HandleFileSelect()">Read</button>
  <br>
  <div id="Display"></div>
  <br>
</body>
</html>
