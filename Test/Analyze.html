<!DOCTYPE html>
<html>
<head>
  <title>File Analyzer</title>
  <script src="json2.js"></script>
  <script>
    //独自定義関数----------------------------------------
    function Analyze(stringData) {
      var dictionaryData = {};

      if (stringData.indexOf("WF_EVENT arrive") !== -1) {
        dictionaryData["eventName"] = "WF_EVENT arrive";
        dictionaryData["rowData"] = stringData;


        
      }
      return dictionaryData;
    }
    //Process管理関数----------------------------------------
    function handleFileSelect() {

      if (BrowzerType() == "Internet Explorer"){
        ProcessIE();
      }else{
        Process();
      }

    }
    function Process() {
      var fileInput = document.getElementById('fileInput');
      var file = fileInput.files[0];

      var reader = new FileReader();

      reader.onload = function(e) {
        var file_content = e.target.result;
        //List化
        var lines = file_content.split('\n');

        var result = [];

        for (var i = 0; i < lines.length; i++) {
          //不要なSpaces削除
          var line = lines[i].trim();
          //解析しDictionary Data化
          var analyzed_data = Analyze(line);

          if (Object.keys(analyzed_data).length !== 0) {
            analyzed_data.row = i + 1;
            result.push(analyzed_data);
          }
        }

        var jsonResult = result.map(function(data) {
          return JSON.stringify(data);
        }).join('\n');

        SaveToFile(file.name + '.json', jsonResult);

        // ブラウザに表示
        var json_lines = jsonResult.split('\n');
        // json_lines = json_lines.slice(0, 3);
        DisplayArray(json_lines,"display",true);
      };

      reader.readAsText(file);
    }

    function ProcessIE() {
      var fileInput = document.getElementById('fileInput');
      var file = fileInput.value;

      var file_system = new ActiveXObject("Scripting.file_systemObject");
      var file_stream = file_system.OpenTextFile(file, 1);
      var file_content = file_stream.ReadAll();
      file_stream.Close();

      var lines = file_content.split('\r\n');
      var results = [];

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        // 空白文字を手動で削除
        line = line.replace(/^\s+|\s+$/g, '');
        var result = Analyze(line);
        if (!IsEmpty(result)) {
          result.row = i + 1;
          results.push(result);
        }
      }

      var jsonResult = '';
      for (var j = 0; j < results.length; j++) {
        jsonResult += DictionaryToJSON(results[j]) + '\r\n';
      }

      SaveToFileIE(file + '.json', jsonResult);
      displayLink(file + '.json', file + '.json','body');
      // ブラウザに表示
      var json_lines = jsonResult.split('\n');
      // json_lines = json_lines.slice(0, 3);
      DisplayArray(json_lines, 'display',true);
    }


    //汎用関数----------------------------------------
    // オブジェクトが空かどうかをチェックする関数
    function IsEmpty(obj) {
      for (var key in obj) {
        if (obj.hasOwnProperty(key)) {
          return false;
        }
      }
      return true;
    }

    // 辞書のJSON文字列化関数
    function DictionaryToJSON(obj) {
      var json_string = '{';
      var is_first_property = true;
      for (var key in obj) {
        if (obj.hasOwnProperty(key)) {
          if (!is_first_property) {
            json_string += ',';
          }
          json_string += '"' + key + '":"' + obj[key] + '"';
          is_first_property = false;
        }
      }
      json_string += '}';
      return json_string;
    }
    //文字列表示関数
    function DisplayString(line, element = 'body' , search_id = false) {
      var display_element;
      if (search_id) {
        display_element = document.getElementById(element);
      }else{
        display_element = document.getElementsByTagName(element)[0];
      }
      display_element.innerHTML = "<p>" + line + "</p>";
      //document.body.innerHTML += "<p>" + line + "</p>";
    }
    //文字列追記関数
    function DisplayAddString(line, element = 'body' , search_id = false) {
      var display_element;
      if (search_id) {
        display_element = document.getElementById(element);
      }else{
        display_element = document.getElementsByTagName(element)[0];
      }
      display_element.innerHTML += "<p>" + line + "</p>";
    }
    //文字列表示関数(配列の表示。配列を変更すればいいので追記の関数は用意しない。)
    function DisplayArray(lines, element = 'body' , search_id = false) {
      var display_element;
      if (search_id) {
        display_element = document.getElementById(element);
      }else{
        display_element = document.getElementsByTagName(element)[0];
      }
      var display_lines = lines.join('<br>');
      display_element.innerHTML = display_lines;
    }
    function DisplayLink(path, labelText,element = 'body', search_id = false) {
          var display_element;
          if (search_id) {
            display_element = document.getElementById(element);
          }else{
            display_element = document.getElementsByTagName(element)[0];
          }
          // リンクの作成
          var link = document.createElement('a');
          link.href = path;
          link.innerText = labelText;
          
          // リンクをbodyに追加
          display_element.appendChild(link);
    }
    //ブラウザ種類判別関数
    function BrowzerType(){
      var browzer_type =""; 
      if (navigator.appName === "Microsoft Internet Explorer" ) {
        return browzer_type = "Internet Explorer";
      }
      var agent = window.navigator.userAgent;
      agent = agent.toLowerCase();
      if (agent.indexOf("msie") != -1 || agent.indexOf("trident") != -1) {
        browzer_type = "Internet Explorer";
      } else if (agent.indexOf("edg") != -1 || agent.indexOf("edge") != -1) {
        browzer_type = "Edge";
      } else if (agent.indexOf("opr") != -1 || agent.indexOf("opera") != -1) {
        browzer_type = "Opera";
      } else if (agent.indexOf("chrome") != -1) {
        browzer_type = "Chrome";
      } else if (agent.indexOf("safari") != -1) {
        browzer_type = "Safari";
      } else if (agent.indexOf("firefox") != -1) {
        browzer_type = "FireFox";
      } else if (agent.indexOf("opr") != -1 || agent.indexOf("opera") != -1) {
        browzer_type = "Opera";
      }
      return browzer_type;
    }

    // ファイル保存関数
    function SaveToFile(fileName, content) {
      var downloadLink = document.createElement('a');
      downloadLink.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
      downloadLink.setAttribute('download', fileName);
      downloadLink.style.display = 'none';

      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }
    // ファイル保存関数(IE専用)
    function SaveToFileIE(fileName, content) {
      var file_system = new ActiveXObject("Scripting.file_systemObject");
      var file_stream = file_system.CreateTextFile(fileName, true);
      file_stream.Write(content);
      file_stream.Close();
    }

  </script>
</head>
<body>
  <h1>File Analyzer</h1>
  <a>InternetExplorerで実行する場合はjson2.jsを同じFolderに置いて実行してください。</a><br>
  <a href="https://cdnjs.cloudflare.com/ajax/libs/json2/20160511/json2.js">https://cdnjs.cloudflare.com/ajax/libs/json2/20160511/json2.js</a>
  <br>
  <input type="file" id="fileInput" />
  <button onclick="handleFileSelect()">Read</button>
  <br>
  <div id="display"></div>
  <br>
</body>
</html>
